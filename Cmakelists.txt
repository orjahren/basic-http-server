cmake_minimum_required(VERSION 3.20)
project(AppC LANGUAGES C)

add_executable(app src/main.c)

# Require C11 (use c_std_99 for C99, c_std_17 for C17)
target_compile_features(app PRIVATE c_std_11)

# Include headers under include/
target_include_directories(app PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/include)

# Example: extra warnings
if(CMAKE_C_COMPILER_ID MATCHES "GNU|Clang")
  target_compile_options(app PRIVATE -Wall -Wextra -Wpedantic)
elseif(MSVC)
  target_compile_options(app PRIVATE /W4)
endif()

find_program(CURL curl REQUIRED)

add_test(
  NAME smoke.root
  COMMAND ${CURL} --fail --silent --show-error http://127.0.0.1:8080/
)
# You still need a way to start/stop the server. One option is a small script:
# - start server in background, wait for port, curl, then kill.


# Ensure we can call Python
find_package(Python3 REQUIRED COMPONENTS Interpreter)

# Integration test using the Python harness
add_executable(client_test src/test/client.c)
target_include_directories(client_test PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/include)

add_test(
  NAME it.basic_http
  COMMAND ${Python3_EXECUTABLE}
          ${CMAKE_CURRENT_SOURCE_DIR}/test/http_test.py
          --server $<TARGET_FILE:http_server>
)

# If tests bind to a real port, avoid parallel clashes:
set_tests_properties(it.basic_http PROPERTIES RUN_SERIAL TRUE)
